
@startuml PyBOP Architecture

!theme plain
skinparam classAttributeIconSize 0
skinparam monochrome true
skinparam packageStyle rectangle
skinparam defaultFontName Arial
skinparam classFontSize 10



' Parameters Package
package "parameters" {
    class Parameter {
        -name: str
        -initial_value: float
        -true_value: float
        -prior: BasePrior
        -bounds: list
        -transformation: Transformation
        +update()
        +rvs()
    }

    class Parameters {
        -param_list: list[Parameter]
        +join()
        +get_bounds()
        +update()
        +rvs()
        +construct_transformation()
    }
    Parameters ..> Parameter : "contains"

}



' Problems Package
package "Problems" {
    abstract class Problem {
        -_params: Parameters
        +run(): np.ndarray
        +run_with_sensitivities(): tuple[np.ndarray, np.ndarray]
        +set_params(p: np.ndarray)
    }

    class PybammProblem extends Problem

    class PybammEISProblem extends Problem

    class PythonProblem extends Problem

}



' Optimisers Package
package "Optimisers" {


    abstract class BaseOptimiser {
        -problem: Problem
        -logger: OptimisationLogger
        -options: OptimisationOptions
        +run(): OptimisationResult
        +{static} default_options(): OptimiserOptions
    }

    class BasePintsOptimiser extends BaseOptimiser {
        -problem: Problem
        -pints_optimiser
        -options: PintsOptions
        +run(): OptimisationResult
        +{static} default_options(): PintsOptions
    }

    class BaseSciPyOptimiser extends BaseOptimiser {
        -problem: Problem
        -options: OptimiserOptions
        +run(): OptimisationResult
    }

    class OptimisationResult {
        -problem: Problem
        -x: np.ndarray
        -final_cost: float
        -n_iterations: int
        -message: str
        -scipy_result: scipy.optimize.OptimizeResult
    }

}

' Transformations Package
package "Transformations" {
    abstract class Transformation <<ABC>> {
        +jacobian()
        +_transform()
        +to_model()
        +to_search()
        +convert_covariance_matrix()
        +log_jacobian_det()
    }
}

' Builders Package
package "Builders" {
    abstract class BaseBuilder <<ABC>> {
        +set_dataset(dataset: Dataset)
        +add_parameter(parameter: Parameter)
        +build(): Problem
    }

    class Pybamm extends BaseBuilder {
        +set_simulation(model: pybamm.BaseModel, ...)
        +add_cost(cost: PybammCost, weight: float)
        +remove_costs()
        +build(): PybammProblem
    }

    class PybammEIS extends BaseBuilder {
        +set_simulation(model: pybamm.BaseModel, ...)
        +add_cost(cost: Callable, weight: float)
        +build(): PybammEISProblem
    }

    class Python extends BaseBuilder {
        +add_fun(model: Callable, weight: float)
        +add_fun_with_sens(model_with_sens: Callable, weight: float)
        +build(): PythonProblem
    }

    class MultiFitting extends BaseBuilder {
        +add_problem(problem: Problem, weight: float)
        +remove_problems()
        +build(): PythonProblem
    }
}

' Base Cost Classes
package "costs" {

    ' Core Base Classes
    class CallableCost {
        -weighting: str | np.ndarray
        +__init__(weighting)
        +__call__(r, dy): float | tuple
    }

    ' PyBaMM Costs Package

    class PybammCost {
        +variable_expression(model, dataset)
    }

}

' Plotting Package
package "Plotting" {
    class PlotFunctions <<static>> {
        +problem()
        +convergence()
        +parameters()
        +surface()
        +quick_plot()
    }

    class PosteriorSummary {
        +plot()
        +summary()
    }
}

' Key Relationships
BaseOptimiser ..> Problem : "minimizes"
Parameter ..> Transformation : "applies"

' Builder relationships
BaseBuilder ..> Problem : "creates"
Pybamm ..> PybammProblem : "builds"
Pybamm ..> PybammCost : "uses"
Python ..> CallableCost: "uses"
PybammEIS ..> CallableCost: "uses"
PybammEIS ..> PybammEISProblem : "builds"
MultiFitting ..> PythonProblem : "builds"
Python ..> PythonProblem : "builds"
Problem ..> Parameters : "contains"

' Additional key relationships
OptimisationResult ..> BaseOptimiser : "produced by"

@enduml
